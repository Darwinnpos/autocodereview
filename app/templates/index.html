{% extends "base.html" %}

{% block title %}AutoCodeReview - 首页{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-play-circle"></i>
                    开始代码审查
                </h5>
            </div>
            <div class="card-body">
                <form id="reviewForm">
                    <div class="mb-3">
                        <label for="mrUrl" class="form-label">GitLab MR URL</label>
                        <input type="url" class="form-control" id="mrUrl"
                               placeholder="https://gitlab.com/group/project/-/merge_requests/123" required>
                        <div class="form-text">请输入完整的GitLab Merge Request URL</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-play"></i>
                            开始审查
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="validateBtn">
                            <i class="bi bi-check-circle"></i>
                            验证URL
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 进度显示卡片 -->
        <div id="progressCard" class="card mt-4" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear"></i>
                    正在进行代码审查
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span id="progressStatus">准备中...</span>
                </div>

                <div class="progress mb-3" style="height: 20px;">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        0%
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="small text-muted">
                            <i class="bi bi-files"></i>
                            已处理文件: <span id="processedFiles">0</span> / <span id="totalFiles">0</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="small text-muted">
                            <i class="bi bi-bug"></i>
                            发现问题: <span id="foundIssues">0</span>
                        </div>
                    </div>
                </div>

                <div id="currentFileInfo" class="mt-3" style="display: none;">
                    <div class="small">
                        <i class="bi bi-file-code"></i>
                        正在分析: <span id="currentFileName" class="text-primary"></span>
                    </div>
                </div>

                <!-- 取消按钮 -->
                <div class="mt-3">
                    <button type="button" class="btn btn-outline-danger btn-sm" id="cancelReviewBtn">
                        <i class="bi bi-x-circle"></i>
                        取消审查
                    </button>
                </div>
            </div>
        </div>

        <div id="resultCard" class="card mt-4" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-file-text"></i>
                    审查结果
                </h5>
            </div>
            <div class="card-body">
                <div id="resultContent"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i>
                    使用说明
                </h5>
            </div>
            <div class="card-body">
                <ol>
                    <li>首先在<a href="/config">配置管理</a>页面设置您的GitLab访问信息</li>
                    <li>粘贴GitLab Merge Request的完整URL</li>
                    <li>点击"开始审查"按钮</li>
                    <li>系统会自动分析代码并生成待确认的评论</li>
                    <li>您可以确认后将评论发布到GitLab MR</li>
                </ol>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-lightbulb"></i>
                    支持的功能
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li><i class="bi bi-check-circle text-success"></i> 语法错误检测</li>
                    <li><i class="bi bi-check-circle text-success"></i> 安全漏洞扫描</li>
                    <li><i class="bi bi-check-circle text-success"></i> 性能问题识别</li>
                    <li><i class="bi bi-check-circle text-success"></i> 代码风格检查</li>
                    <li><i class="bi bi-check-circle text-success"></i> 最佳实践建议</li>
                    <li><i class="bi bi-check-circle text-success"></i> 按行精准评论</li>
                </ul>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-file-code"></i>
                    支持的语言
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-3">
                        <i class="bi bi-file-code display-6 text-primary"></i>
                        <div class="small">Python</div>
                    </div>
                    <div class="col-3">
                        <i class="bi bi-braces display-6 text-warning"></i>
                        <div class="small">JavaScript</div>
                    </div>
                    <div class="col-3">
                        <i class="bi bi-code-square display-6 text-danger"></i>
                        <div class="small">Java</div>
                    </div>
                    <div class="col-3">
                        <i class="bi bi-terminal display-6 text-success"></i>
                        <div class="small">C++</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Debug version - v1.0.2
// 全局变量
let reviewProgressInterval = null;
let currentReviewIdForCancel = null;

document.getElementById('reviewForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const mrUrl = document.getElementById('mrUrl').value;
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const progressCard = document.getElementById('progressCard');
    const resultCard = document.getElementById('resultCard');
    const resultContent = document.getElementById('resultContent');

    // 显示加载状态
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 启动中...';

    // 隐藏结果卡片，显示进度卡片
    resultCard.style.display = 'none';
    progressCard.style.display = 'block';

    // 重置进度显示
    resetProgress();

    try {
        // 启动审查（异步）
        const response = await axios.post('/api/review', {
            mr_url: mrUrl
        });

        if (response.data.success) {
            // 异步API返回的数据结构是 {success: true, message: "审查已启动", review_id: 123}
            console.log('Full API response:', response.data);
            const reviewId = response.data.review_id;
            console.log('Starting progress polling for review ID:', reviewId);

            if (reviewId) {
                // 保存当前审查ID用于取消功能
                currentReviewIdForCancel = reviewId;

                // 锁定页面，防止用户意外离开
                lockPage(
                    '代码审查正在进行中，离开页面将中断审查过程',
                    function() { // 用户确认离开时的回调
                        console.log('用户确认取消审查并离开页面');
                        // 尝试取消审查
                        cancelCurrentReview();
                    },
                    function() { // 用户取消离开时的回调
                        console.log('用户取消离开页面，继续审查');
                    }
                );

                // 开始轮询进度
                startProgressPolling(reviewId);
            } else {
                throw new Error('未获取到审查ID');
            }

        } else {
            throw new Error(response.data.error || '审查失败');
        }
    } catch (error) {
        // 解锁页面
        unlockPage();

        // 隐藏进度卡片，显示详细错误
        progressCard.style.display = 'none';

        const errorMessage = error.response?.data?.error || error.message;
        let errorIcon = 'bi-exclamation-triangle';
        let errorTitle = '审查失败';
        let errorSuggestion = '';

        // 根据错误类型提供具体的图标和建议
        if (errorMessage.includes('GitLab连接失败') || errorMessage.includes('GitLab认证失败')) {
            errorIcon = 'bi-git';
            errorTitle = 'GitLab连接问题';
            errorSuggestion = '<small class="text-muted">请检查个人资料中的GitLab URL和访问令牌配置</small>';
        } else if (errorMessage.includes('GitLab权限不足') || errorMessage.includes('GitLab资源未找到')) {
            errorIcon = 'bi-shield-exclamation';
            errorTitle = 'GitLab权限问题';
            errorSuggestion = '<small class="text-muted">请确保您有权限访问该项目和Merge Request</small>';
        } else if (errorMessage.includes('AI服务超时') || errorMessage.includes('请求超过120秒未响应')) {
            errorIcon = 'bi-clock';
            errorTitle = 'AI服务超时';
            errorSuggestion = '<small class="text-muted">代码分析耗时过长，请尝试减少文件数量或稍后重试</small>';
        } else if (errorMessage.includes('AI服务') || errorMessage.includes('AI API')) {
            errorIcon = 'bi-robot';
            errorTitle = 'AI服务问题';
            errorSuggestion = '<small class="text-muted">请检查个人资料中的AI API配置，或稍后重试</small>';
        } else if (errorMessage.includes('AI模型') && errorMessage.includes('不可用')) {
            errorIcon = 'bi-robot';
            errorTitle = 'AI模型不可用';
            errorSuggestion = '<small class="text-muted">请检查个人资料中的AI模型配置是否正确</small>';
        } else if (errorMessage.includes('配置错误')) {
            errorIcon = 'bi-gear-fill';
            errorTitle = '配置问题';
            errorSuggestion = '<small class="text-muted">请到个人资料页面完善配置信息</small>';
        } else if (errorMessage.includes('数据库错误')) {
            errorIcon = 'bi-database-exclamation';
            errorTitle = '系统错误';
            errorSuggestion = '<small class="text-muted">系统内部错误，请联系管理员或稍后重试</small>';
        } else if (errorMessage.includes('审查记录不存在')) {
            // 对于"审查记录不存在"错误，显示更具体的错误信息
            errorIcon = 'bi-exclamation-circle';
            errorTitle = '审查记录不存在';
        }

        resultContent.innerHTML = `
            <div class="alert alert-danger">
                <h6><i class="${errorIcon}"></i> ${errorTitle}</h6>
                <p class="mb-2">${errorMessage}</p>
                ${errorSuggestion}
            </div>
        `;
        resultCard.style.display = 'block';

        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-play"></i> 开始审查';
    }
});

function resetProgress() {
    document.getElementById('progressStatus').textContent = '准备中...';
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressBar').textContent = '0%';
    document.getElementById('progressBar').setAttribute('aria-valuenow', '0');
    document.getElementById('processedFiles').textContent = '0';
    document.getElementById('totalFiles').textContent = '0';
    document.getElementById('foundIssues').textContent = '0';
    document.getElementById('currentFileInfo').style.display = 'none';
}

function startProgressPolling(reviewId) {
    console.log('Starting progress polling for review:', reviewId);

    // 立即设置按钮为稳定的审查状态
    const submitBtn = document.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 审查中...';
        submitBtn.disabled = true;
    }

    // 设置进度状态为审查中
    document.getElementById('progressStatus').textContent = '正在分析代码...';

    // 使用更长的间隔进行轮询，仅检查是否完成
    reviewProgressInterval = setInterval(async () => {
        try {
            const response = await axios.get(`/api/review/${reviewId}/progress`);
            if (response.data.success) {
                const progress = response.data.data;

                // 只更新文件计数和进度条，不频繁更新按钮状态
                updateProgressCounts(progress);

                // 如果审查完成、失败或被取消，停止轮询并显示结果
                if (progress.status === 'completed' || progress.status === 'failed' || progress.status === 'cancelled') {
                    clearInterval(reviewProgressInterval);
                    reviewProgressInterval = null;
                    currentReviewIdForCancel = null;

                    // 解锁页面
                    unlockPage();

                    if (progress.status === 'cancelled') {
                        // 处理取消状态
                        handleCancelledReview();
                    } else {
                        showFinalResult(reviewId);
                    }
                }
            } else {
                console.error('Progress API returned error:', response.data);
            }
        } catch (error) {
            console.error('获取进度失败:', error);
            // 如果是客户端错误或网络错误，停止轮询
            if (error.response && error.response.status === 400) {
                console.log('审查已失败，停止轮询');
                clearInterval(reviewProgressInterval);
                reviewProgressInterval = null;
                currentReviewIdForCancel = null;
                unlockPage();
                // 恢复按钮状态
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="bi bi-play"></i> 开始审查';
                    submitBtn.disabled = false;
                }
                // 隐藏取消按钮
                const cancelBtn = document.getElementById('cancelReviewBtn');
                if (cancelBtn) {
                    cancelBtn.style.display = 'none';
                }
            }
        }
    }, 5000); // 每5秒轮询一次，减少频率
}

function updateProgressCounts(progress) {
    console.log('updateProgressCounts called with:', progress);

    // 更新状态文本
    const statusTexts = {
        'preparing': '准备中...',
        'analyzing': '正在分析代码...',
        'generating_comments': '正在生成评论...',
        'saving_results': '正在保存结果...',
        'completed': '分析完成！',
        'failed': '分析失败',
        'cancelled': '已取消'
    };
    const statusText = statusTexts[progress.status] || progress.status;
    document.getElementById('progressStatus').textContent = statusText;

    // 更新进度条
    let percentage = 0;
    if (progress.status === 'preparing' || progress.total_files === 0) {
        // 准备阶段显示不确定进度
        percentage = 10; // 显示一点进度表示已开始
        document.getElementById('progressBar').classList.add('progress-bar-animated');
    } else {
        percentage = Math.round((progress.processed_files / Math.max(progress.total_files, 1)) * 100);
        document.getElementById('progressBar').classList.remove('progress-bar-animated');
    }

    document.getElementById('progressBar').style.width = percentage + '%';
    document.getElementById('progressBar').textContent = percentage + '%';
    document.getElementById('progressBar').setAttribute('aria-valuenow', percentage);

    // 更新文件计数
    document.getElementById('processedFiles').textContent = progress.processed_files;
    if (progress.status === 'preparing' && progress.total_files === 0) {
        document.getElementById('totalFiles').textContent = '...';
    } else {
        document.getElementById('totalFiles').textContent = progress.total_files;
    }
    document.getElementById('foundIssues').textContent = progress.total_issues;

    // 更新当前文件信息
    if (progress.current_file && progress.status === 'analyzing') {
        document.getElementById('currentFileName').textContent = progress.current_file;
        document.getElementById('currentFileInfo').style.display = 'block';
    } else {
        document.getElementById('currentFileInfo').style.display = 'none';
    }

    // 根据状态调整进度条颜色
    const progressBar = document.getElementById('progressBar');
    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
    if (progress.status === 'completed') {
        progressBar.classList.add('bg-success');
    } else if (progress.status === 'failed') {
        progressBar.classList.add('bg-danger');
    }
}

function updateProgress(progress) {
    console.log('updateProgress called with:', progress);

    // 更新状态文本
    const statusTexts = {
        'preparing': '准备中...',
        'analyzing': '正在分析代码...',
        'generating_comments': '正在生成评论...',
        'saving_results': '正在保存结果...',
        'completed': '分析完成！',
        'failed': '分析失败',
        'cancelled': '已取消'
    };
    const statusText = statusTexts[progress.status] || progress.status;
    console.log('Setting status text to:', statusText);
    document.getElementById('progressStatus').textContent = statusText;

    // 更新按钮状态
    const submitBtn = document.querySelector('button[type="submit"]');
    const buttonTexts = {
        'preparing': '<span class="spinner-border spinner-border-sm" role="status"></span> 启动中...',
        'analyzing': '<span class="spinner-border spinner-border-sm" role="status"></span> 审查中...',
        'generating_comments': '<span class="spinner-border spinner-border-sm" role="status"></span> 生成评论中...',
        'saving_results': '<span class="spinner-border spinner-border-sm" role="status"></span> 保存结果中...',
        'completed': '<i class="bi bi-play"></i> 开始审查',
        'failed': '<i class="bi bi-play"></i> 开始审查'
    };

    const buttonText = buttonTexts[progress.status] || '<span class="spinner-border spinner-border-sm" role="status"></span> 处理中...';
    if (submitBtn) {
        submitBtn.innerHTML = buttonText;
        // 只有在完成或失败时才启用按钮
        submitBtn.disabled = !['completed', 'failed'].includes(progress.status);
    }

    // 更新进度条
    let percentage = 0;
    if (progress.status === 'preparing' || progress.total_files === 0) {
        // 准备阶段显示不确定进度
        percentage = 0;
        document.getElementById('progressBar').classList.add('progress-bar-animated');
    } else {
        percentage = Math.round((progress.processed_files / Math.max(progress.total_files, 1)) * 100);
    }

    document.getElementById('progressBar').style.width = percentage + '%';
    document.getElementById('progressBar').textContent = percentage + '%';
    document.getElementById('progressBar').setAttribute('aria-valuenow', percentage);

    // 更新文件计数
    console.log('Updating file counts - processed:', progress.processed_files, 'total:', progress.total_files, 'issues:', progress.total_issues);
    document.getElementById('processedFiles').textContent = progress.processed_files;
    if (progress.status === 'preparing' && progress.total_files === 0) {
        console.log('Using ... for total files (preparing status)');
        document.getElementById('totalFiles').textContent = '...';
    } else {
        console.log('Setting total files to:', progress.total_files);
        document.getElementById('totalFiles').textContent = progress.total_files;
    }
    document.getElementById('foundIssues').textContent = progress.total_issues;
    console.log('Updated DOM elements');

    // 更新当前文件信息
    if (progress.current_file && progress.status === 'analyzing') {
        document.getElementById('currentFileName').textContent = progress.current_file;
        document.getElementById('currentFileInfo').style.display = 'block';
    } else {
        document.getElementById('currentFileInfo').style.display = 'none';
    }

    // 根据状态调整进度条颜色
    const progressBar = document.getElementById('progressBar');
    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
    if (progress.status === 'completed') {
        progressBar.classList.add('bg-success');
    } else if (progress.status === 'failed') {
        progressBar.classList.add('bg-danger');
    }
}

async function showFinalResult(reviewId) {
    const submitBtn = document.querySelector('button[type="submit"]');
    const progressCard = document.getElementById('progressCard');
    const resultCard = document.getElementById('resultCard');
    const resultContent = document.getElementById('resultContent');

    try {
        // 获取最终结果
        const response = await axios.get(`/api/review/${reviewId}/result`);
        if (response.data.success) {
            const data = response.data.data;

            // 隐藏进度卡片，显示结果
            progressCard.style.display = 'none';

            resultContent.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="bi bi-check-circle"></i> 代码分析完成！</h6>
                    <p class="mb-1">已成功分析 ${data.analysis_summary.total_files_analyzed} 个文件</p>
                    <p class="mb-1">发现 ${data.analysis_summary.total_issues_found} 个问题</p>
                    <p class="mb-0">生成了 ${data.pending_comments_count} 条待确认的评论</p>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6>问题分布:</h6>
                        <ul class="list-unstyled">
                            <li class="severity-error"><i class="bi bi-exclamation-triangle-fill"></i> 错误: ${data.analysis_summary.issues_by_severity.error}</li>
                            <li class="severity-warning"><i class="bi bi-exclamation-triangle"></i> 警告: ${data.analysis_summary.issues_by_severity.warning}</li>
                            <li class="severity-info"><i class="bi bi-info-circle"></i> 建议: ${data.analysis_summary.issues_by_severity.info}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>MR信息:</h6>
                        <p class="small">
                            <strong>标题:</strong> ${data.mr_info.title}<br>
                            <strong>作者:</strong> ${data.mr_info.author}<br>
                            <strong>分支:</strong> ${data.mr_info.source_branch} → ${data.mr_info.target_branch}
                        </p>
                    </div>
                </div>
                <div class="d-flex gap-2 mt-3">
                    <a href="${data.mr_info.web_url}" target="_blank" class="btn btn-primary btn-sm">
                        <i class="bi bi-arrow-up-right-square"></i>
                        查看MR
                    </a>
                    ${data.pending_comments_count > 0 ? `
                        <button type="button" class="btn btn-warning btn-sm" onclick="loadPendingComments(${data.review_id})">
                            <i class="bi bi-chat-dots"></i>
                            查看待确认评论 (${data.pending_comments_count})
                        </button>
                    ` : ''}
                </div>
            `;
            resultCard.style.display = 'block';
        } else {
            throw new Error(response.data.error || '获取结果失败');
        }
    } catch (error) {
        progressCard.style.display = 'none';

        const errorMessage = error.response?.data?.error || error.message;
        let errorIcon = 'bi-exclamation-triangle';
        let errorTitle = '获取结果失败';
        let errorSuggestion = '';

        // 根据错误类型提供具体的图标和建议
        if (errorMessage.includes('AI服务') || errorMessage.includes('AI API')) {
            errorIcon = 'bi-robot';
            errorTitle = 'AI分析失败';
            errorSuggestion = '<small class="text-muted">AI服务在代码分析过程中出现问题，请检查AI配置或稍后重试</small>';
        } else if (errorMessage.includes('AI模型') && errorMessage.includes('不可用')) {
            errorIcon = 'bi-robot';
            errorTitle = 'AI模型不可用';
            errorSuggestion = '<small class="text-muted">请检查个人资料中的AI模型配置是否正确</small>';
        } else if (errorMessage.includes('GitLab')) {
            errorIcon = 'bi-git';
            errorTitle = 'GitLab数据获取失败';
            errorSuggestion = '<small class="text-muted">无法从GitLab获取代码数据，请检查网络连接和权限设置</small>';
        } else if (errorMessage.includes('数据库')) {
            errorIcon = 'bi-database-exclamation';
            errorTitle = '系统错误';
            errorSuggestion = '<small class="text-muted">系统内部错误，请联系管理员</small>';
        } else if (errorMessage.includes('审查记录不存在')) {
            // 对于"审查记录不存在"错误，显示更具体的错误信息
            errorIcon = 'bi-exclamation-circle';
            errorTitle = '审查记录不存在';
        }

        resultContent.innerHTML = `
            <div class="alert alert-danger">
                <h6><i class="${errorIcon}"></i> ${errorTitle}</h6>
                <p class="mb-2">${errorMessage}</p>
                ${errorSuggestion}
            </div>
        `;
        resultCard.style.display = 'block';
    } finally {
        // 解锁页面
        unlockPage();

        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-play"></i> 开始审查';
    }
}

document.getElementById('validateBtn').addEventListener('click', async function() {
    const mrUrl = document.getElementById('mrUrl').value;
    const btn = this;

    if (!mrUrl) {
        alert('请输入MR URL');
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 验证中...';

    try {
        const response = await axios.post('/api/validate-mr-url', {
            mr_url: mrUrl
        });

        if (response.data.data.valid) {
            alert('URL格式正确');
        } else {
            alert(response.data.data.error);
        }
    } catch (error) {
        alert('验证失败: ' + (error.response?.data?.error || error.message));
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle"></i> 验证URL';
    }
});

async function loadPendingComments(reviewId) {
    try {
        const response = await axios.get(`/api/review/${reviewId}/pending-comments`);
        if (response.data.success) {
            showPendingCommentsModal(response.data.data.pending_comments, reviewId);
        } else {
            alert('获取待确认评论失败');
        }
    } catch (error) {
        alert('获取待确认评论失败: ' + (error.response?.data?.error || error.message));
    }
}

// 全局变量用于分页
let currentComments = [];
let currentReviewId = null;
let currentPage = 1;
const pageSize = 5; // 每页显示5条评论

function showPendingCommentsModal(comments, reviewId) {
    currentComments = comments;
    currentReviewId = reviewId;
    currentPage = 1;

    const modalHtml = `
        <div class="modal fade" id="pendingCommentsModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-chat-dots"></i>
                            待确认评论 (${comments.length} 条)
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <button type="button" class="btn btn-success btn-sm" onclick="selectAllComments()">
                                    <i class="bi bi-check-all"></i>
                                    全选当前页
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllSelections()">
                                    <i class="bi bi-x-square"></i>
                                    清空选择
                                </button>
                                <span class="text-muted ms-3" id="pageInfo">第 1 页，共 ${Math.ceil(comments.length / pageSize)} 页</span>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="bulkConfirmComments(${reviewId})">
                                <i class="bi bi-send"></i>
                                批量确认选中的评论
                            </button>
                        </div>

                        <!-- 分页导航 -->
                        <nav aria-label="评论分页" class="mb-3">
                            <ul class="pagination pagination-sm justify-content-center" id="paginationTop">
                                <!-- 分页按钮将动态生成 -->
                            </ul>
                        </nav>

                        <div id="commentsContainer">
                            <!-- 评论内容将动态加载 -->
                        </div>

                        <!-- 底部分页导航 -->
                        <nav aria-label="评论分页" class="mt-3">
                            <ul class="pagination pagination-sm justify-content-center" id="paginationBottom">
                                <!-- 分页按钮将动态生成 -->
                            </ul>
                        </nav>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary" onclick="bulkConfirmComments(${reviewId})">
                            <i class="bi bi-send"></i>
                            确认选中的评论
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // 移除现有的modal如果存在
    const existingModal = document.getElementById('pendingCommentsModal');
    if (existingModal) {
        existingModal.remove();
    }

    // 添加新的modal到页面
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // 显示modal
    const modal = new bootstrap.Modal(document.getElementById('pendingCommentsModal'));
    modal.show();

    // 加载第一页评论
    loadCommentsPage(1);
}

function loadCommentsPage(page) {
    currentPage = page;
    const startIndex = (page - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, currentComments.length);
    const pageComments = currentComments.slice(startIndex, endIndex);

    // 生成当前页评论HTML
    const commentsHtml = pageComments.map(comment => generateCommentHtml(comment, currentReviewId)).join('');

    // 更新评论容器
    document.getElementById('commentsContainer').innerHTML = commentsHtml;

    // 自动加载当前页所有评论的代码上下文
    pageComments.forEach(comment => {
        loadCodeContextForComment(currentReviewId, comment.id);
    });

    // 更新页面信息
    const totalPages = Math.ceil(currentComments.length / pageSize);
    document.getElementById('pageInfo').textContent = `第 ${page} 页，共 ${totalPages} 页 (显示 ${startIndex + 1}-${endIndex} / ${currentComments.length})`;

    // 更新分页按钮
    updatePagination(page, totalPages);
}

function generateCommentHtml(comment, reviewId) {
    return `
        <div class="card mb-3 comment-card" data-issue-id="${comment.id}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="form-check">
                    <input class="form-check-input comment-checkbox" type="checkbox" value="${comment.id}">
                    <label class="form-check-label">
                        <strong>${comment.file_path}:${comment.line_number}</strong>
                        <span class="badge bg-${getSeverityColor(comment.severity)} ms-2">${comment.severity}</span>
                        <span class="badge bg-secondary ms-1">${comment.category}</span>
                    </label>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-success btn-sm" onclick="confirmSingleComment(${reviewId}, ${comment.id})">
                        <i class="bi bi-check"></i>
                        确认
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="rejectSingleComment(${reviewId}, ${comment.id})">
                        <i class="bi bi-x"></i>
                        拒绝
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- 代码上下文容器 - 默认显示 -->
                <div class="code-context-container mb-3" id="context-${comment.id}">
                    <div class="text-center p-3 border rounded bg-light">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <div class="mt-2 text-muted">正在加载代码上下文...</div>
                    </div>
                </div>

                <!-- 问题和建议 -->
                <div class="border-top pt-3">
                    <p class="mb-2"><strong>问题:</strong> ${comment.message}</p>
                    <p class="mb-0"><strong>建议:</strong> ${comment.suggestion || '无'}</p>
                </div>

            </div>
        </div>
    `;
}

function updatePagination(currentPage, totalPages) {
    const paginationHtml = generatePaginationHtml(currentPage, totalPages);
    document.getElementById('paginationTop').innerHTML = paginationHtml;
    document.getElementById('paginationBottom').innerHTML = paginationHtml;
}

function generatePaginationHtml(currentPage, totalPages) {
    if (totalPages <= 1) return '';

    let html = '';

    // 上一页按钮
    html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToPage(${currentPage - 1})">上一页</a>
    </li>`;

    // 页码按钮（最多显示7个）
    let startPage = Math.max(1, currentPage - 3);
    let endPage = Math.min(totalPages, startPage + 6);

    // 调整起始页
    if (endPage - startPage < 6) {
        startPage = Math.max(1, endPage - 6);
    }

    // 第一页
    if (startPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(1)">1</a></li>`;
        if (startPage > 2) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }

    // 中间页码
    for (let i = startPage; i <= endPage; i++) {
        html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
        </li>`;
    }

    // 最后一页
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${totalPages})">${totalPages}</a></li>`;
    }

    // 下一页按钮
    html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToPage(${currentPage + 1})">下一页</a>
    </li>`;

    return html;
}

function goToPage(page) {
    const totalPages = Math.ceil(currentComments.length / pageSize);
    if (page < 1 || page > totalPages) return;
    loadCommentsPage(page);
}

// 存储已加载的代码上下文
const loadedContexts = new Map();

async function loadCodeContextForComment(reviewId, issueId) {
    const container = document.getElementById(`context-${issueId}`);

    if (!container) {
        console.error(`Context container not found for issue ${issueId}`);
        return;
    }

    // 检查是否已经加载过
    if (loadedContexts.has(issueId)) {
        container.innerHTML = loadedContexts.get(issueId);
        return;
    }

    try {
        const response = await axios.get(`/api/review/${reviewId}/comment/${issueId}/context`);

        if (response.data.success) {
            const contextHtml = `
                <div class="border rounded" style="font-family: 'Courier New', monospace; font-size: 13px; overflow-x: auto; background-color: white;">
                    ${renderCodeContext(response.data.data.context)}
                </div>
            `;

            // 缓存已加载的内容
            loadedContexts.set(issueId, contextHtml);
            container.innerHTML = contextHtml;
        } else {
            container.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    无法加载代码上下文：${response.data.error || '未知错误'}
                </div>
            `;
        }
    } catch (error) {
        console.error('Failed to load code context:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle"></i>
                加载失败：${error.response?.data?.error || error.message || '网络错误'}
            </div>
        `;
    }
}

function getSeverityColor(severity) {
    switch (severity) {
        case 'error': return 'danger';
        case 'warning': return 'warning';
        case 'info': return 'info';
        default: return 'secondary';
    }
}

function selectAllComments() {
    // 只选择当前页显示的评论
    document.querySelectorAll('#commentsContainer .comment-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
}

function clearAllSelections() {
    // 清除所有页面的选择（包括已确认但不在当前页的）
    document.querySelectorAll('#commentsContainer .comment-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
}

async function confirmSingleComment(reviewId, issueId) {
    try {
        const response = await axios.post(`/api/review/${reviewId}/confirm-comment/${issueId}`);
        if (response.data.success) {
            // 移除该评论卡片
            const card = document.querySelector(`[data-issue-id="${issueId}"]`);
            if (card) {
                card.remove();
            }
            showToast('success', '评论已确认并发布到GitLab');
        } else {
            showToast('error', '确认评论失败');
        }
    } catch (error) {
        showToast('error', '确认评论失败: ' + (error.response?.data?.error || error.message));
    }
}

async function rejectSingleComment(reviewId, issueId) {
    try {
        const response = await axios.post(`/api/review/${reviewId}/reject-comment/${issueId}`);
        if (response.data.success) {
            // 移除该评论卡片
            const card = document.querySelector(`[data-issue-id="${issueId}"]`);
            if (card) {
                card.remove();
            }
            showToast('success', '评论已拒绝');
        } else {
            showToast('error', '拒绝评论失败');
        }
    } catch (error) {
        showToast('error', '拒绝评论失败: ' + (error.response?.data?.error || error.message));
    }
}

async function bulkConfirmComments(reviewId) {
    const selectedCheckboxes = document.querySelectorAll('.comment-checkbox:checked');
    const issueIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));

    if (issueIds.length === 0) {
        alert('请选择要确认的评论');
        return;
    }

    try {
        const response = await axios.post(`/api/review/${reviewId}/bulk-confirm`, {
            issue_ids: issueIds
        });

        if (response.data.success) {
            // 移除已确认的评论卡片
            issueIds.forEach(issueId => {
                const card = document.querySelector(`[data-issue-id="${issueId}"]`);
                if (card) {
                    card.remove();
                }
            });
            showToast('success', response.data.message);

            // 如果没有更多评论，关闭modal
            const remainingCards = document.querySelectorAll('.comment-card');
            if (remainingCards.length === 0) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('pendingCommentsModal'));
                modal.hide();
            }
        } else {
            showToast('error', '批量确认失败');
        }
    } catch (error) {
        showToast('error', '批量确认失败: ' + (error.response?.data?.error || error.message));
    }
}

function showToast(type, message) {
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    // 创建toast容器如果不存在
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }

    // 添加toast
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);

    // 显示toast
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();

    // 自动移除toast
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

function renderCodeContext(context) {
    if (!context) return '';

    // 使用数组拼接而非字符串连接，提高性能
    const lines = [];

    // 渲染前面的行（白底灰色文字）
    if (context.lines_before && context.lines_before.length > 0) {
        context.lines_before.forEach(line => {
            lines.push(`<div class="code-line context-line" style="background-color: white; color: #495057; padding: 4px 12px; border-left: 2px solid #dee2e6; line-height: 1.4;">
                <span class="line-number" style="color: #6c757d; margin-right: 16px; min-width: 45px; display: inline-block; font-family: 'Consolas', 'Monaco', monospace; text-align: right;">${line.line_number}</span>
                <span class="line-content" style="font-family: 'Consolas', 'Monaco', 'Courier New', monospace; white-space: pre; tab-size: 4;">${preserveSpaces(escapeHtml(line.content))}</span>
            </div>`);
        });
    }

    // 渲染目标行（红色左边框表示问题行）
    if (context.target_line) {
        lines.push(`<div class="code-line target-line" style="background-color: #fff5f5; color: #d63384; padding: 4px 12px; border-left: 4px solid #dc3545; line-height: 1.4; font-weight: 500;">
            <span class="line-number" style="color: #dc3545; margin-right: 16px; min-width: 45px; display: inline-block; font-family: 'Consolas', 'Monaco', monospace; text-align: right; font-weight: bold;">${context.target_line.line_number}</span>
            <span class="line-content" style="font-family: 'Consolas', 'Monaco', 'Courier New', monospace; white-space: pre; tab-size: 4;">${preserveSpaces(escapeHtml(context.target_line.content))}</span>
        </div>`);
    }

    // 渲染后面的行（白底灰色文字）
    if (context.lines_after && context.lines_after.length > 0) {
        context.lines_after.forEach(line => {
            lines.push(`<div class="code-line context-line" style="background-color: white; color: #495057; padding: 4px 12px; border-left: 2px solid #dee2e6; line-height: 1.4;">
                <span class="line-number" style="color: #6c757d; margin-right: 16px; min-width: 45px; display: inline-block; font-family: 'Consolas', 'Monaco', monospace; text-align: right;">${line.line_number}</span>
                <span class="line-content" style="font-family: 'Consolas', 'Monaco', 'Courier New', monospace; white-space: pre; tab-size: 4;">${preserveSpaces(escapeHtml(line.content))}</span>
            </div>`);
        });
    }

    return lines.join('');
}

function preserveSpaces(text) {
    // 保留原始空格和制表符
    return text.replace(/ /g, ' ').replace(/\t/g, '    ');
}

function escapeHtml(text) {
    if (!text) return '';
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
}

function handleCancelledReview() {
    const submitBtn = document.querySelector('button[type="submit"]');
    const progressCard = document.getElementById('progressCard');
    const resultCard = document.getElementById('resultCard');
    const resultContent = document.getElementById('resultContent');

    // 隐藏进度卡片
    progressCard.style.display = 'none';

    // 显示取消结果
    resultContent.innerHTML = `
        <div class="alert alert-warning">
            <h6><i class="bi bi-x-circle"></i> 审查已取消</h6>
            <p class="mb-1">代码审查已被取消</p>
            <p class="mb-0">您可以随时重新开始审查</p>
        </div>
    `;
    resultCard.style.display = 'block';

    // 重置表单状态
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="bi bi-play"></i> 开始审查';
}

// 取消当前审查的函数
async function cancelCurrentReview() {
    if (!currentReviewIdForCancel) {
        console.log('No review to cancel');
        return;
    }

    try {
        const response = await axios.post(`/api/review/${currentReviewIdForCancel}/cancel`);
        if (response.data.success) {
            console.log('Review successfully cancelled');

            // 停止进度轮询
            if (reviewProgressInterval) {
                clearInterval(reviewProgressInterval);
                reviewProgressInterval = null;
            }

            // 清理全局状态
            currentReviewIdForCancel = null;
        }
    } catch (error) {
        console.error('Failed to cancel review:', error);
    }
}

// 取消审查功能
document.getElementById('cancelReviewBtn').addEventListener('click', async function() {
    if (!currentReviewIdForCancel) {
        alert('没有正在进行的审查可以取消');
        return;
    }

    if (!confirm('确定要取消当前的代码审查吗？\n取消后将无法恢复已分析的数据。')) {
        return;
    }

    const cancelBtn = this;
    const originalText = cancelBtn.innerHTML;

    // 显示取消中状态
    cancelBtn.disabled = true;
    cancelBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 取消中...';

    try {
        const response = await axios.post(`/api/review/${currentReviewIdForCancel}/cancel`);

        if (response.data.success) {
            // 停止进度轮询
            if (reviewProgressInterval) {
                clearInterval(reviewProgressInterval);
                reviewProgressInterval = null;
            }

            // 隐藏进度卡片
            document.getElementById('progressCard').style.display = 'none';

            // 显示取消结果
            const resultCard = document.getElementById('resultCard');
            const resultContent = document.getElementById('resultContent');

            resultContent.innerHTML = `
                <div class="alert alert-warning">
                    <h6><i class="bi bi-x-circle"></i> 审查已取消</h6>
                    <p class="mb-1">代码审查已被用户主动取消</p>
                    <p class="mb-0">您可以随时重新开始审查</p>
                </div>
            `;
            resultCard.style.display = 'block';

            // 重置表单
            const submitBtn = document.querySelector('button[type="submit"]');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-play"></i> 开始审查';

            // 清理全局状态
            currentReviewIdForCancel = null;

            // 解锁页面
            unlockPage();

            showToast('success', '审查已成功取消');
        } else {
            throw new Error(response.data.error || '取消失败');
        }
    } catch (error) {
        const errorMessage = error.response?.data?.error || error.message;
        showToast('error', '取消审查失败: ' + errorMessage);
    } finally {
        // 恢复取消按钮状态
        cancelBtn.disabled = false;
        cancelBtn.innerHTML = originalText;
    }
});

// 页面加载时检查URL参数
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const mrUrl = urlParams.get('mr_url');

    if (mrUrl) {
        // 自动填入MR URL
        document.getElementById('mrUrl').value = decodeURIComponent(mrUrl);

        // 滚动到表单位置
        document.getElementById('reviewForm').scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });

        // 可选：自动聚焦到输入框
        document.getElementById('mrUrl').focus();

        // 清除URL参数（保持页面整洁）
        const newUrl = window.location.pathname;
        window.history.replaceState({}, '', newUrl);
    }
});
</script>
{% endblock %}